<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #4CAF50;
      --white: #FFFFFF;
      --yellow: #FFEB3B;
      --red: #F44336;
      --gold: #ffc107;
    }
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--white);
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--white);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--green);
      padding-bottom: 20px;
    }
    .header img {
      height: 80px;
      margin-right: 20px;
    }
    .header h1 {
      margin: 0;
      color: var(--green);
      font-size: 2.5em;
    }
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1em;
      transition: background-color 0.3s ease;
      margin: 5px;
    }
    .btn-green {
      background-color: var(--green);
      color: var(--white);
    }
    .btn-green:hover {
      background-color: #388E3C;
    }
    .btn-secondary {
      background-color: #9e9e9e;
      color: var(--white);
    }
    .btn-secondary:hover {
      background-color: #757575;
    }
    .login-section, .hof-section, .badges-section {
      text-align: center;
      margin-bottom: 30px;
    }
    .login-section input[type="text"] {
      padding: 12px;
      width: 60%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1.1em;
      margin-right: 10px;
    }
    .student-info {
      background-color: #e8f5e9;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 25px;
      border: 1px solid var(--green);
    }
    .student-info p {
      margin: 8px 0;
      font-size: 1.1em;
    }
    .student-info p strong {
      color: var(--green);
    }
    .nilai-table, .hof-table, .badges-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .nilai-table th, .nilai-table td, .hof-table th, .hof-table td, .badges-table th, .badges-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }
    .nilai-table th {
      background-color: var(--green);
      color: var(--white);
      font-weight: bold;
    }
    .nilai-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .nilai-table tr:hover {
      background-color: #f1f1f1;
    }
    .highlight-row {
      background-color: var(--yellow) !important;
      font-weight: bold;
    }
    .hof-table thead th {
      background-color: var(--gold);
      color: var(--white);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .hof-table tr:nth-child(odd) {
      background-color: #f9f9f9;
    }
    .hof-table tr:hover {
      background-color: #f1f1f1;
    }
    .badges-table th {
      background-color: #f0ad4e;
      color: var(--white);
      font-weight: bold;
    }
    #error-message-nilai, #error-message-hof, #error-message-badges {
      color: var(--red);
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
    }
    #loading-message {
      text-align: center;
      font-size: 1.2em;
      color: var(--green);
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://iili.io/FqqmPFp.png" alt="Logo Sekolah">
      <h1 id="pageTitle">MATH CASTLE</h1>
    </div>
    
    <div style="text-align:center; margin-bottom: 20px;">
      <button class="btn btn-green" id="showNilaiBtn" onclick="showSection('nilai')">Lihat Nilai</button>
      <button class="btn btn-secondary" id="showBadgesBtn" onclick="showSection('badges')">My Badges</button>
      <button class="btn btn-secondary" id="showHofBtn" onclick="showSection('hof')">Hall Of Fame</button>
    </div>

    <div id="loading-message">Mengambil data dari server...</div>

    <div id="nilai-section" style="display:none;">
      <div class="login-section">
        <p>Masukkan NISN Anda untuk melihat nilai:</p>
        <input type="text" id="nisnInputNilai" placeholder="Masukkan NISN">
        <button class="btn btn-green" onclick="getNilai()">Cari Nilai</button>
        <div id="error-message-nilai"></div>
      </div>
      <div id="result-container-nilai" style="display:none;">
        <div class="student-info">
          <p><strong>NAMA LENGKAP : </strong> <span id="namaLengkapNilai"></span></p>
          <p><strong>NISN : </strong> <span id="nisnDisplayNilai"></span></p>
          <p><strong>KELAS : </strong> <span id="kelasDisplay"></span></p>
          <p><strong>PREDIKAT : </strong> <span id="predikatNilai"></span></p>
          <p><strong>KEHADIRAN : </strong> <span id="kehadiranDisplay"></span></p>
        </div>
        <table class="nilai-table">
          <thead>
            <tr>
              <th>ASPEK PENILAIAN</th>
              <th>NILAI</th>
            </tr>
          </thead>
          <tbody id="nilaiTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="badges-section" style="display:none;">
      <div class="login-section">
        <p>Masukkan NISN Anda untuk melihat My Badges:</p>
        <input type="text" id="nisnInputBadges" placeholder="Masukkan NISN">
        <button class="btn btn-green" onclick="getBadges()">Cari Badges</button>
        <div id="error-message-badges"></div>
      </div>
      <div id="result-container-badges" style="display:none;">
        <div class="student-info">
          <p><strong>NAMA LENGKAP : </strong> <span id="namaLengkapBadges"></span></p>
          <p><strong>NISN : </strong> <span id="nisnDisplayBadges"></span></p>
          <p><strong>POIN : </strong> <span id="poinDisplay"></span></p>
        </div>
        <h2 style="text-align: center;">MY BADGES</h2>
        <table class="badges-table">
          <thead>
            <tr>
              <th>NO.</th>
              <th>BADGES</th>
              <th>POIN</th>
            </tr>
          </thead>
          <tbody id="myBadgesTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="hof-section" style="display:none;">
      <div class="table-container">
        <table class="hof-table">
          <thead>
            <tr>
              <th>No.</th>
              <th>Nama</th>
              <th>Poin</th>
              <th>Badges</th>
            </tr>
          </thead>
          <tbody id="hofTableBody"></tbody>
        </table>
      </div>
      <div id="hof-loading-message" style="display:none;"><p>Loading data...</p></div>
      <div id="error-message-hof" class="error-message" style="display:none;"></div>
    </div>
  </div>

  <script>
    const CSV_URL_NILAI = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnw5Bm8vr7kZu45jaY3GKSYXXW4ooFohGm1tZfC4n8rPyPuG3qYc2xRPZvc9VMTkjGWHhl7eAsqzPp/pub?gid=1829383988&single=true&output=csv';
    const CSV_URL_GAME = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnw5Bm8vr7kZu45jaY3GKSYXXW4ooFohGm1tZfC4n8rPyPuG3qYc2xRPZvc9VMTkjGWHhl7eAsqzPp/pub?gid=1080330117&single=true&output=csv';
    const CSV_URL_GAME2 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnw5Bm8vr7kZu45jaY3GKSYXXW4ooFohGm1tZfC4n8rPyPuG3qYc2xRPZvc9VMTkjGWHhl7eAsqzPp/pub?gid=714629508&single=true&output=csv';
    
    let allData = {};

    // Custom CSV parser
    function parseCsv(csvText) {
      const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
      if (lines.length === 0) return [];

      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length === headers.length) {
          const entry = {};
          headers.forEach((header, index) => {
            entry[header] = values[index].trim();
          });
          data.push(entry);
        }
      }
      return data;
    }
    
    // Main initialization function
    async function init() {
      try {
        const [nilaiResponse, gameResponse, game2Response] = await Promise.all([
          fetch(CSV_URL_NILAI),
          fetch(CSV_URL_GAME),
          fetch(CSV_URL_GAME2)
        ]);

        const [nilaiText, gameText, game2Text] = await Promise.all([
          nilaiResponse.text(),
          gameResponse.text(),
          game2Response.text()
        ]);
        
        allData.nilai = parseCsv(nilaiText);
        allData.game = parseCsv(gameText);
        allData.game2 = parseCsv(game2Text);

        document.getElementById('loading-message').style.display = 'none';
        showSection('nilai'); // Show initial section
        
      } catch (error) {
        document.getElementById('loading-message').textContent = 'Gagal memuat data. Mohon periksa koneksi internet atau tautan CSV.';
        console.error('Failed to load CSV data:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', init);

    function showSection(section) {
      const sections = ['nilai', 'badges', 'hof'];
      sections.forEach(s => {
        document.getElementById(`${s}-section`).style.display = 'none';
        document.getElementById(`show${s.charAt(0).toUpperCase() + s.slice(1)}Btn`).classList.remove('btn-green');
        document.getElementById(`show${s.charAt(0).toUpperCase() + s.slice(1)}Btn`).classList.add('btn-secondary');
      });

      document.getElementById(`${section}-section`).style.display = 'block';
      document.getElementById(`show${section.charAt(0).toUpperCase() + section.slice(1)}Btn`).classList.remove('btn-secondary');
      document.getElementById(`show${section.charAt(0).toUpperCase() + section.slice(1)}Btn`).classList.add('btn-green');
      
      const pageTitles = {
        nilai: 'NILAI MATEMATIKA',
        badges: 'MY BADGES',
        hof: 'HALL OF FAME'
      };
      document.getElementById('pageTitle').textContent = pageTitles[section];

      if (section === 'hof') {
        loadHallOfFameData();
      }
    }

    function getNilai() {
      const nisn = document.getElementById('nisnInputNilai').value.trim();
      const errorMessage = document.getElementById('error-message-nilai');
      const resultContainer = document.getElementById('result-container-nilai');
      const nilaiTableBody = document.getElementById('nilaiTableBody');

      errorMessage.textContent = '';
      resultContainer.style.display = 'none';
      nilaiTableBody.innerHTML = '';

      if (!nisn) {
        errorMessage.textContent = 'Mohon masukkan NISN Anda.';
        return;
      }
      
      const data = allData.nilai;
      const studentData = data.find(row => String(row['NISN']).trim() === nisn);
      
      if (!studentData) {
        errorMessage.textContent = 'NISN tidak ditemukan. Mohon periksa kembali NISN Anda.';
        resultContainer.style.display = 'none';
        return;
      }
      
      displayNilai(studentData);
    }
    
    function displayNilai(data) {
      document.getElementById('namaLengkapNilai').textContent = data['NAMA LENGKAP'];
      document.getElementById('nisnDisplayNilai').textContent = data['NISN'];
      document.getElementById('kelasDisplay').textContent = data['KELAS'];
      document.getElementById('predikatNilai').textContent = data['PREDIKAT'];
      
      let kehadiranValue = parseFloat(data['LOGIN']);
      if (!isNaN(kehadiranValue) && kehadiranValue > 0 && kehadiranValue <= 1) {
          kehadiranValue = Math.round(kehadiranValue * 100);
      }
      document.getElementById('kehadiranDisplay').textContent = kehadiranValue ? kehadiranValue + '%' : '-';

      const nilaiTableBody = document.getElementById('nilaiTableBody');
      const aspekPenilaian = [
        "LKS BAB 1", "LKS BAB 2", "LKS BAB 3",
        "CATATAN TUGAS BAB 1", "CATATAN TUGAS BAB 2", "CATATAN TUGAS BAB 3",
        "KETERAMPILAN BAB 1", "KETERAMPILAN BAB 2", "KETERAMPILAN BAB 3",
        "ATS LKS", "ATS ASLI", "ATS PERBAIKAN 25 SOAL",
        "AAS LKS", "AAS ASLI", "PENILAIAN HARIAN",
        "NILAI AKHIR ATS", "NILAI AKHIR AAS"
      ];

      aspekPenilaian.forEach(aspek => {
        const row = nilaiTableBody.insertRow();
        const aspekCell = row.insertCell();
        const nilaiCell = row.insertCell();

        aspekCell.textContent = aspek;
        nilaiCell.textContent = data[aspek] !== undefined ? Math.round(parseFloat(data[aspek])) : '-';

        if (aspek === "NILAI AKHIR ATS" || aspek === "NILAI AKHIR AAS" || aspek === "PENILAIAN HARIAN") {
          row.classList.add('highlight-row');
        }
      });
      document.getElementById('result-container-nilai').style.display = 'block';
    }

    function getBadges() {
      const nisn = document.getElementById('nisnInputBadges').value.trim();
      const errorMessage = document.getElementById('error-message-badges');
      const resultContainer = document.getElementById('result-container-badges');
      const myBadgesTableBody = document.getElementById('myBadgesTableBody');
      
      errorMessage.textContent = '';
      resultContainer.style.display = 'none';
      myBadgesTableBody.innerHTML = '';

      if (!nisn) {
        errorMessage.textContent = 'Mohon masukkan NISN Anda.';
        return;
      }

      const badgesData = allData.game2;
      const studentBadgesData = badgesData.find(row => String(row['NISN']).trim() === nisn);
      
      if (!studentBadgesData) {
        errorMessage.textContent = 'NISN tidak ditemukan. Mohon periksa kembali NISN Anda.';
        resultContainer.style.display = 'none';
        return;
      }
      
      const gameData = allData.game;
      const studentPoinData = gameData.find(row => String(row['NISN']).trim() === nisn);

      const badgesList = Object.keys(studentBadgesData).filter(key => key.startsWith('BADGES '));
      const myBadges = [];
      badgesList.forEach(badgeKey => {
        if (studentBadgesData[badgeKey].trim() !== '') {
          const badgeName = studentBadgesData[badgeKey].trim();
          let poin = '-';
          if (studentPoinData) {
            // Find the point for this badge
            const poinKey = Object.keys(studentPoinData).find(key => key.includes(badgeName));
            if (poinKey) {
              poin = studentPoinData[poinKey];
            }
          }
          myBadges.push({ badge: badgeName, poin: poin });
        }
      });

      document.getElementById('namaLengkapBadges').textContent = studentBadgesData['NAMA LENGKAP'];
      document.getElementById('nisnDisplayBadges').textContent = studentBadgesData['NISN'];
      document.getElementById('poinDisplay').textContent = studentBadgesData['POIN BADGES'];

      if (myBadges.length > 0) {
        myBadges.forEach((item, index) => {
          const row = myBadgesTableBody.insertRow();
          const noCell = row.insertCell();
          const badgeCell = row.insertCell();
          const poinCell = row.insertCell();
          
          noCell.textContent = index + 1;
          badgeCell.textContent = item.badge;
          poinCell.textContent = item.poin;
        });
      } else {
          const row = myBadgesTableBody.insertRow();
          const cell = row.insertCell();
          cell.colSpan = 3;
          cell.textContent = "Tidak ada badges yang ditemukan.";
      }
      
      resultContainer.style.display = 'block';
    }

    function loadHallOfFameData() {
      const tableBody = document.getElementById('hofTableBody');
      const hofData = allData.game;

      tableBody.innerHTML = '';

      if (hofData.length === 0) {
        document.getElementById('error-message-hof').textContent = 'Tidak ada data Hall of Fame yang ditemukan.';
        return;
      }

      const topData = hofData.slice(0, 20); // Ambil 20 baris pertama
      topData.forEach((row, index) => {
        const newRow = tableBody.insertRow();
        const noCell = newRow.insertCell();
        const namaCell = newRow.insertCell();
        const poinCell = newRow.insertCell();
        const badgesCell = newRow.insertCell();
        
        noCell.textContent = index + 1;
        namaCell.textContent = row['NAMA'];
        poinCell.textContent = row['POIN'];
        badgesCell.textContent = row['BADGES'];
      });
    }

  </script>
</body>
</html>